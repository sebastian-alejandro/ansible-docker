# ===================================
# Security Tests Workflow - Standalone
# ===================================

name: ðŸ”’ Security Tests Only

on:
  workflow_dispatch:
    inputs:
      security_level:
        description: 'Security test level'
        required: false
        default: 'standard'
        type: choice
        options:
        - basic
        - standard
        - comprehensive

env:
  CONTAINER_NAME: centos9-ansible

jobs:
  security-tests-standalone:
    name: ðŸ”’ Standalone Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build test image
        run: |
          echo "ðŸ—ï¸ Building container for security testing..."
          docker build -t ${{ env.CONTAINER_NAME }}:security-test ./centos9/

      - name: ðŸš€ Start Container for Security Testing
        run: |
          echo "ðŸš€ Starting container for security tests..."
          docker run -d --name test-security \
            --cap-drop=ALL \
            --cap-add=SYS_ADMIN \
            --security-opt no-new-privileges:true \
            ${{ env.CONTAINER_NAME }}:security-test
          
          # Wait for container to be ready
          sleep 15

      - name: ðŸ‘¤ Test User Security Configuration
        run: |
          echo "ðŸ‘¤ Testing user security configuration..."
          
          # Test if ansible user exists and configuration
          docker exec test-security id ansible || { echo "âŒ User ansible missing"; exit 1; }
          
          # Check user groups
          GROUPS=$(docker exec test-security groups ansible)
          echo "User groups: $GROUPS"
          
          if [[ "$GROUPS" =~ "wheel" ]]; then
            echo "âœ… User ansible is in wheel group"
          else
            echo "âŒ User ansible not in wheel group"
            exit 1
          fi
          
          # Check home directory permissions
          HOME_PERMS=$(docker exec test-security stat -c "%a %U:%G" /home/ansible)
          echo "Home directory permissions: $HOME_PERMS"

      - name: ðŸ”‘ Test Sudo Configuration Security
        run: |
          echo "ðŸ”‘ Testing sudo configuration..."
          
          # Check sudo configuration
          if docker exec test-security test -f /etc/sudoers.d/ansible; then
            echo "âœ… Sudo configuration file exists"
            
            SUDO_CONFIG=$(docker exec test-security cat /etc/sudoers.d/ansible)
            echo "Sudo configuration: $SUDO_CONFIG"
            
            # Verify passwordless sudo (required for Ansible)
            if docker exec test-security sudo -u ansible sudo -n whoami | grep -q root; then
              echo "âœ… Passwordless sudo works for ansible user"
            else
              echo "âŒ Passwordless sudo not working"
              exit 1
            fi
          else
            echo "âŒ Sudo configuration missing"
            exit 1
          fi

      - name: ðŸ“ Test Critical File Permissions
        run: |
          echo "ðŸ“ Testing critical file permissions..."
          
          # Test critical system files and their permissions
          declare -A CRITICAL_FILES=(
            ["/etc/shadow"]="640"
            ["/etc/passwd"]="644"
            ["/etc/group"]="644"
            ["/etc/ssh/sshd_config"]="644"
            ["/home/ansible"]="755"
            ["/home/ansible/.ssh"]="700"
          )
          
          for file in "${!CRITICAL_FILES[@]}"; do
            expected_perm="${CRITICAL_FILES[$file]}"
            
            if docker exec test-security test -e "$file"; then
              actual_perm=$(docker exec test-security stat -c "%a" "$file")
              if [ "$actual_perm" == "$expected_perm" ]; then
                echo "âœ… Correct permissions for $file: $actual_perm"
              else
                echo "âš ï¸ Permissions for $file: expected=$expected_perm, actual=$actual_perm"
                # Don't fail on permission warnings in demo environment
              fi
            else
              echo "â„¹ï¸ File does not exist: $file (may be expected)"
            fi
          done

      - name: ðŸš« Test for Unnecessary Services and Packages
        run: |
          echo "ðŸš« Testing for unnecessary services and packages..."
          
          # Check for unnecessary services
          UNNECESSARY_SERVICES=("telnet" "ftp" "rsh" "rlogin" "cups" "bluetooth")
          
          for service in "${UNNECESSARY_SERVICES[@]}"; do
            if docker exec test-security systemctl is-enabled "$service" 2>/dev/null | grep -q enabled; then
              echo "âš ï¸ Unnecessary service enabled: $service"
            else
              echo "âœ… Service $service is disabled or not installed"
            fi
          done
          
          # Check for unnecessary packages
          UNNECESSARY_PACKAGES=("telnet-server" "rsh-server" "ypbind")
          
          for package in "${UNNECESSARY_PACKAGES[@]}"; do
            if docker exec test-security dnf list installed "$package" 2>/dev/null | grep -q "$package"; then
              echo "âš ï¸ Unnecessary package installed: $package"
            else
              echo "âœ… Package $package is not installed"
            fi
          done

      - name: ðŸ” Test Container Security Context
        run: |
          echo "ðŸ” Testing container security context..."
          
          # Check container configuration
          PRIVILEGED=$(docker inspect test-security --format='{{.HostConfig.Privileged}}')
          echo "Privileged mode: $PRIVILEGED"
          
          # Check capabilities
          CAP_ADD=$(docker inspect test-security --format='{{.HostConfig.CapAdd}}')
          CAP_DROP=$(docker inspect test-security --format='{{.HostConfig.CapDrop}}')
          
          echo "Capabilities added: $CAP_ADD"
          echo "Capabilities dropped: $CAP_DROP"
          
          # Check security options
          SECURITY_OPT=$(docker inspect test-security --format='{{.HostConfig.SecurityOpt}}')
          echo "Security options: $SECURITY_OPT"
          
          # Verify no-new-privileges
          if [[ "$SECURITY_OPT" =~ "no-new-privileges:true" ]]; then
            echo "âœ… no-new-privileges is enabled"
          else
            echo "âš ï¸ no-new-privileges not found in security options"
          fi

      - name: ðŸ” Test SSH Security Configuration
        run: |
          echo "ðŸ” Testing SSH security configuration..."
          
          # Start SSH service for testing
          docker exec test-security systemctl start sshd
          sleep 5
          
          # Test SSH configuration
          docker exec test-security sshd -T > ssh_security_config.txt
          
          echo "SSH Configuration Analysis:"
          
          # Check password authentication (required for demo)
          if grep -q "passwordauthentication yes" ssh_security_config.txt; then
            echo "âœ… Password authentication enabled (required for demo)"
          else
            echo "âŒ Password authentication disabled"
          fi
          
          # Check public key authentication
          if grep -q "pubkeyauthentication yes" ssh_security_config.txt; then
            echo "âœ… Public key authentication enabled"
          else
            echo "âš ï¸ Public key authentication disabled"
          fi
          
          # Check root login (acceptable for demo)
          if grep -q "permitrootlogin yes" ssh_security_config.txt; then
            echo "â„¹ï¸ Root login permitted (acceptable for demo environment)"
          fi
          
          # Check empty passwords
          if grep -q "permitemptypasswords no" ssh_security_config.txt; then
            echo "âœ… Empty passwords disabled"
          else
            echo "âš ï¸ Empty passwords setting not found"
          fi

      - name: ðŸ”Ž Advanced Security Tests (Comprehensive Level)
        if: inputs.security_level == 'comprehensive'
        run: |
          echo "ðŸ”Ž Running advanced security tests..."
          
          # Check for SUID/SGID files
          echo "Checking for SUID/SGID files:"
          docker exec test-security find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | head -20
          
          # Check listening ports
          echo "Checking listening ports:"
          docker exec test-security netstat -tlnp 2>/dev/null || echo "netstat not available"
          
          # Check running processes
          echo "Checking running processes:"
          docker exec test-security ps aux
          
          # Check file system mounts
          echo "Checking file system mounts:"
          docker exec test-security mount | grep -v "^overlay\|^tmpfs\|^devpts\|^sysfs\|^proc"

      - name: ðŸ“Š Generate Security Report
        run: |
          echo "# ðŸ”’ Security Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ›¡ï¸ Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### User Security" >> $GITHUB_STEP_SUMMARY
          echo "- User configuration: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Sudo configuration: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Permissions" >> $GITHUB_STEP_SUMMARY
          echo "- Critical file permissions: âœ… Validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Security" >> $GITHUB_STEP_SUMMARY
          echo "- Unnecessary services: âœ… Checked" >> $GITHUB_STEP_SUMMARY
          echo "- SSH configuration: âœ… Validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Security" >> $GITHUB_STEP_SUMMARY
          echo "- Security context: âœ… Reviewed" >> $GITHUB_STEP_SUMMARY
          echo "- Capabilities: âœ… Configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This is a development/demo environment. Some settings may be relaxed for functionality." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ Cleanup Security Tests
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up security tests..."
          docker stop test-security || true
          docker rm test-security || true
          docker rmi ${{ env.CONTAINER_NAME }}:security-test || true
