# ===================================
# Build Tests Workflow - Standalone
# ===================================

name: ðŸ”¨ Build Tests Only

on:
  workflow_dispatch:
    inputs:
      cache_strategy:
        description: 'Docker build cache strategy'
        required: false
        default: 'gha'
        type: choice
        options:
        - gha
        - registry
        - inline

env:
  CONTAINER_NAME: centos9-ansible

jobs:
  build-tests-standalone:
    name: ðŸ”¨ Standalone Build Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.CONTAINER_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=build-test

      - name: ðŸ—ï¸ Build Container Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./centos9
          platforms: linux/amd64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=${{ inputs.cache_strategy }}
          cache-to: type=${{ inputs.cache_strategy }},mode=max

      - name: ðŸ” Validate Container Metadata
        run: |
          echo "ðŸ·ï¸ Validating container labels and metadata..."
          
          # Check required labels
          MAINTAINER=$(docker inspect --format='{{index .Config.Labels "maintainer"}}' ${{ env.CONTAINER_NAME }}:build-test)
          VERSION=$(docker inspect --format='{{index .Config.Labels "version"}}' ${{ env.CONTAINER_NAME }}:build-test)
          DESCRIPTION=$(docker inspect --format='{{index .Config.Labels "description"}}' ${{ env.CONTAINER_NAME }}:build-test)
          
          echo "ðŸ“‹ Container Metadata:"
          echo "  Maintainer: $MAINTAINER"
          echo "  Version: $VERSION"
          echo "  Description: $DESCRIPTION"
          
          # Validate required metadata
          [ "$MAINTAINER" = "DevOps Team" ] || { echo "âŒ Invalid maintainer"; exit 1; }
          [ "$VERSION" = "1.0" ] || { echo "âŒ Invalid version"; exit 1; }
          [ -n "$DESCRIPTION" ] || { echo "âŒ Missing description"; exit 1; }
          
          echo "âœ… Container metadata validation passed"

      - name: ðŸŒ Validate Environment Variables
        run: |
          echo "ðŸ” Validating environment variables..."
          ENV_VARS=$(docker inspect --format='{{.Config.Env}}' ${{ env.CONTAINER_NAME }}:build-test)
          
          echo "ðŸ“‹ Environment Variables: $ENV_VARS"
          
          # Check required environment variables
          [[ "$ENV_VARS" =~ "LANG=en_US.UTF-8" ]] || { echo "âŒ LANG not set"; exit 1; }
          [[ "$ENV_VARS" =~ "ANSIBLE_USER=ansible" ]] || { echo "âŒ ANSIBLE_USER not set"; exit 1; }
          [[ "$ENV_VARS" =~ "ANSIBLE_USER_HOME=/home/ansible" ]] || { echo "âŒ ANSIBLE_USER_HOME not set"; exit 1; }
          
          echo "âœ… Environment variables validation passed"

      - name: ðŸ“ Analyze Image Size and Layers
        run: |
          echo "ðŸ“ Analyzing image size and layers..."
          
          # Show image details
          docker images ${{ env.CONTAINER_NAME }}:build-test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          
          # Show layer information
          echo ""
          echo "ðŸ“‹ Image History (layers):"
          docker history ${{ env.CONTAINER_NAME }}:build-test --format "table {{.CreatedBy}}\t{{.Size}}" --no-trunc
          
          # Get size in bytes for comparison
          SIZE_BYTES=$(docker inspect ${{ env.CONTAINER_NAME }}:build-test --format='{{.Size}}')
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          
          echo ""
          echo "ðŸ“Š Image Size Analysis:"
          echo "  Size in MB: $SIZE_MB"
          
          # Set size thresholds
          if [ $SIZE_MB -gt 3000 ]; then
            echo "âš ï¸ Warning: Image is very large (>3GB)"
          elif [ $SIZE_MB -gt 1500 ]; then
            echo "âš ï¸ Image is large (>1.5GB) - consider optimization"
          else
            echo "âœ… Image size is reasonable"
          fi

      - name: ðŸ” Validate Dockerfile Best Practices
        run: |
          echo "ðŸ” Validating Dockerfile best practices..."
          
          # Check if image uses multi-stage builds (for future optimization)
          if grep -q "FROM.*AS" centos9/Dockerfile; then
            echo "âœ… Multi-stage build detected"
          else
            echo "â„¹ï¸ Single-stage build (acceptable for current implementation)"
          fi
          
          # Check for COPY vs ADD usage
          if grep -q "^ADD" centos9/Dockerfile; then
            echo "âš ï¸ ADD instruction found - consider using COPY instead"
          else
            echo "âœ… Using COPY instruction (good practice)"
          fi
          
          # Check for clean up commands
          if grep -q "dnf clean all" centos9/Dockerfile; then
            echo "âœ… Package cache cleanup found"
          else
            echo "âš ï¸ Consider adding package cache cleanup"
          fi
          
          # Check for non-root user (not applicable for SSH containers)
          echo "â„¹ï¸ Running as root is acceptable for SSH containers"

      - name: ðŸ“Š Generate Build Report
        run: |
          echo "# ðŸ”¨ Build Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.CONTAINER_NAME }}:build-test" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get image size
          SIZE_BYTES=$(docker inspect ${{ env.CONTAINER_NAME }}:build-test --format='{{.Size}}')
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          
          echo "## ðŸ“Š Image Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Layers**: $(docker history ${{ env.CONTAINER_NAME }}:build-test --quiet | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Container metadata: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Environment variables: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile practices: âœ… Passed" >> $GITHUB_STEP_SUMMARY
